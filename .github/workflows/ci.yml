name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  validate:
    name: Validate Action
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate action.yml
        run: |
          echo "Validating action.yml syntax..."
          python3 -c "import yaml; yaml.safe_load(open('action.yml'))"
          echo "✓ action.yml is valid YAML"

      - name: Validate workflow files
        run: |
          echo "Validating workflow files..."
          for file in .github/workflows/*.yml examples/*.yml; do
            if [ -f "$file" ]; then
              echo "Checking $file..."
              python3 -c "import yaml; yaml.safe_load(open('$file'))"
              echo "✓ $file is valid YAML"
            fi
          done

      - name: Validate JSON schema
        run: |
          echo "Validating JSON schema..."
          python3 -c "import json; json.load(open('schema/config.schema.json'))"
          echo "✓ config.schema.json is valid JSON"

      - name: Validate example config
        run: |
          echo "Validating example config..."
          python3 -c "import json; json.load(open('examples/kilocode-config.json'))"
          echo "✓ kilocode-config.json is valid JSON"

  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'

      - name: Run tests
        run: node src/tests/kilocode-resolver.test.mjs

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for common issues
        run: |
          echo "Checking for common issues..."
          
          # Check for trailing whitespace in YAML files
          if grep -r '[[:blank:]]$' --include="*.yml" --include="*.yaml" .; then
            echo "::warning::Found trailing whitespace in YAML files"
          fi
          
          # Check action.yml has required fields
          if ! grep -q "^name:" action.yml; then
            echo "::error::action.yml missing 'name' field"
            exit 1
          fi
          
          if ! grep -q "^description:" action.yml; then
            echo "::error::action.yml missing 'description' field"
            exit 1
          fi
          
          if ! grep -q "^runs:" action.yml; then
            echo "::error::action.yml missing 'runs' field"
            exit 1
          fi
          
          echo "✓ All checks passed"

  docs:
    name: Documentation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check documentation
        run: |
          echo "Checking documentation..."
          
          # Check README exists and has content
          if [ ! -f "README.md" ]; then
            echo "::error::README.md not found"
            exit 1
          fi
          
          if [ ! -s "README.md" ]; then
            echo "::error::README.md is empty"
            exit 1
          fi
          
          # Check LICENSE exists
          if [ ! -f "LICENSE" ]; then
            echo "::error::LICENSE not found"
            exit 1
          fi
          
          # Check examples exist
          if [ ! -d "examples" ]; then
            echo "::error::examples directory not found"
            exit 1
          fi
          
          echo "✓ Documentation checks passed"
